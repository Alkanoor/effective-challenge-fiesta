from PIL import Image


im = Image.open('ch13.png')
w,h = im.size

rgb = [[0 for i in range(w*h)] for j in range(3)]
s = [0 for i in range(3)]
for i in range(w):
    for j in range(h):
        p = im.getpixel((i,j))
        for k in range(3):
            rgb[k][j*w+i] = p[k]&3
            s[k] += 1 if p[k]&3 == 1 or p[k]&3 == 2 else 2 if p[k]&3 == 3 else 0

for k in range(3):
    rgb[k] = rgb[k][w:]

cor = {0: '00', 1: '01', 2: '10', 3: '11'}
import itertools
perms = list(itertools.permutations([0, 1, 2]))

perms = [perms[-3]]
for p in perms:
    r = ""
    for i in range(len(rgb[p[0]])):
        if rgb[p[0]][i] == 2:
            r += cor[rgb[p[1]][i]]
        elif rgb[p[0]][i] == 1:
            r += cor[rgb[p[2]][i]]
        elif rgb[p[0]][i] == 3:
            r += cor[rgb[p[1]][i]]+cor[rgb[p[2]][i]]
    a = int(r[:20000],2)

import binascii

def atos(a):
    h = hex(a)[2:].replace('L','')
    if len(h)%2==1:
        h = '0'+h
    return binascii.unhexlify(h)

print atos(a)
