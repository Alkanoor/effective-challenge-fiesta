#!/usr/bin/python


# file code
# set architecture arm
# target remote 127.0.0.1:1234

# qemu-arm -L /usr/arm-linux-gnueabi/ -g 1234 ./ch50


from pwn import *
import subprocess
import pwn
import sys
import os


gdb_commands = ['source ~/peda-arm/peda-arm.py', 'file ch50', 'target remote localhost:1235']

def launch_debugger():
    p = subprocess.Popen(["gdb-multiarch", "ch50"], stdin=subprocess.PIPE, shell=True)
    p.stdin.write("\n".join(gdb_commands))
    p.communicate()[0]
    p.stdin.close()
    print("ENDING")

def process(r):
    while True:
        print("===========")
        print(r.recv())

if len(sys.argv) > 1:
    debug = True
else:
    debug = False


if debug:
    os.system('xfce4-terminal -e ./qemu_script.sh')
    r = pwn.process(['./listen_send_script.sh'])
    pid = os.fork()
    if pid == 0:
       launch_debugger()
       exit()
    process(r)
else:
    r = remote('challenge04.root-me.org', 61050)
    process(r)
