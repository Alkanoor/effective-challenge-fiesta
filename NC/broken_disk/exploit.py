#!/usr/bin/python

import io
import re
import time
import pycurl
import StringIO
import binascii
from urllib import urlencode


def ok(M):
    for i in M:
        if (M[i][0]<=1.3*M[i][1] and M[i][1]<=1.3*M[i][0]) or (M[i][0]+M[i][1]<10):
            return i
    return -1


def clear(o):
    o.truncate(0)
    o.seek(0)

body_buffer = StringIO.StringIO()
header_buffer = StringIO.StringIO()


c = pycurl.Curl()
c.setopt(c.SSL_VERIFYHOST, 0)
c.setopt(c.WRITEFUNCTION, body_buffer.write)
c.setopt(c.HEADERFUNCTION, header_buffer.write)


c.setopt(c.URL, 'https://www.newbiecontest.org/epreuves/forensics/broken_disk/generate.php')

try:
    M = {}
    while ok(M)>=0 or len(M) == 0:
        c.perform()

        body = body_buffer.getvalue()
        header = header_buffer.getvalue()

        a = bin(int(binascii.hexlify(body), 16)).replace('0b','')
        if len(a)%8 != 0:
            a = '0'*(8-len(a)%8)+a

        for j in range(len(a)):
            if a[j]=='0':
                if M.get(j) is not None:
                    M[j] = (M[j][0]+1, M[j][1])
                else:
                    M[j] = (1,0)
            else:
                if M.get(j) is not None:
                    M[j] = (M[j][0], M[j][1]+1)
                else:
                    M[j] = (0,1)

        clear(body_buffer)
        clear(header_buffer)

        time.sleep(0.5)
        tmp = ok(M)
        print("=> "+str(tmp)+" => "+str(M[tmp]))

    print(M)
except Exception, e:
    print("Interrupting during iteration : "+str(e))
finally:
    final_string = ''
    for i in M:
        if M[i][0] > M[i][1]:
            final_string += '0'
        else:
            final_string += '1'

    print(final_string)
    with open('final_string', 'w') as f:
        f.write(final_string)

    with open('final_file', 'wb') as f:
        f.write(binascii.unhexlify(hex(int(final_string,2)).replace('0x','').replace('L','')))
