#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>


#define prog "/home/input2/input"


int main()
{
    char ref[] = "ref";
    char* argv[101];
    int i=0;
    for(; i<100; i++)
        argv[i] = ref;
    argv[100] = 0;

    argv['A'] = "\x00";
	argv['B'] = "\x20\x0a\x0d";
    argv['C'] = "\x32\x33\x33\x34\x34";

    int fd1[2], fd2[2];
    pipe(fd1);
    pipe(fd2);

    int pid = fork();
    if(pid<0)
    {
        printf("Error\n");
        exit(1);
    }
    else if(pid)
    {
        close(fd1[0]);
        close(fd2[0]);

        write(fd1[1], "\x00\x0a\x00\xff", 4);
        write(fd2[1], "\x00\x0a\x02\xff", 4);

        wait(NULL);

        close(fd1[1]);
        close(fd2[1]);
    }
    else
    {
        close(fd1[1]);
        close(fd2[1]);

        dup2(fd1[0], 0);
        dup2(fd2[0], 2);

        close(fd1[0]);
        close(fd2[0]);

        FILE* fp = fopen("\x0a", "wb");
    	if(!fp)
    	{
    		printf("file create error!\n");
    		exit(-1);
    	}
    	fwrite("\x00\x00\x00\x00", 4, 1, fp);
    	fclose(fp);

        char* env[] = {"\xde\xad\xbe\xef=\xca\xfe\xba\xbe", NULL};
        if(execve(prog, argv, env) < 0)
        {
            printf("Error3\n");
            exit(1);
        }
    }

    //derniere etape :
    //ln -s /home/input2/flag flag
    //python -c 'print "\xde\xad\xbe\xef"' | nc localhost 23344

    return 0;
}
